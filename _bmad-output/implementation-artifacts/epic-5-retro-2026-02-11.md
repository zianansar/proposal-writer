# Epic 5 Retrospective - February 11, 2026

**Project:** Upwork Research Agent
**Epic:** Epic 5 - Strategic Hook Selection & Voice Calibration
**Retrospective Date:** 2026-02-11
**Facilitator:** Bob (Scrum Master)
**Participants:** Zian (Project Lead), Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev)

---

## Executive Summary

Epic 5 delivered **9/9 stories completed** (100%), establishing a complete voice calibration and hook strategy system. The epic implemented hook strategy seed data and selection UI, golden set upload with PDF extraction, local-only voice analysis (7 algorithms), voice profile display and persistence, privacy indicators, quick calibration alternative, and voice-informed proposal generation.

**Key Metrics:**
- **Stories Completed:** 9/9 (100%) — 6th consecutive epic at 100%
- **Tests Written:** ~391 across frontend and backend
- **Code Review Rounds:** 11 (1 story required R2: 5-6)
- **Issues Found & Fixed:** ~62 total (3 CRITICAL, 10 HIGH, 18 MEDIUM, 14 LOW + Round 2 fixes)
- **Migrations Created:** 3 (V19 hook_strategies, V20 golden_set_proposals, V21 voice_profiles)
- **Production Incidents:** 0
- **New Algorithms:** 7 text analysis algorithms (all local, zero API calls)

**Key Achievement:** Complete FR-5 (Hook Strategy Selection) and FR-16 (Golden Set Calibration) delivery — local-only voice analysis preserving privacy (AR-12), with graceful degradation when no voice profile exists.

---

## What Went Well (Successes)

### 1. Privacy-First Voice Analysis (Story 5-4)

**Evidence:** Seven text analysis algorithms run entirely on the user's device with zero API calls: sentence segmentation, average sentence length, Flesch-Kincaid grade level, tone/formality scoring, structure detection, technical depth analysis, and common phrase extraction.

**Impact:**
- AR-12 compliance: Only style parameters sent to AI, never raw proposal text
- Performance: <2s for 5 proposals (AC-3 met)
- Progress events via Tauri's event system for UX feedback
- 29 tests (22 Rust + 7 frontend)

**Lesson:** Complex NLP-style analysis can be done locally with acceptable quality for MVP. The syllable counting heuristic is "good enough" — perfection would require external libraries with diminishing returns.

### 2. Ordered Prompt Architecture (Story 5-8)

**Evidence:** Voice-informed generation uses a clear injection order: Base system prompt → Humanization injection → Voice calibration instructions. This creates layered, non-conflicting prompt behavior.

**Impact:**
- Voice instructions converted to natural language (not raw numbers)
- Label derivation: tone (casual/balanced/professional), depth (layman/intermediate/expert), length (short/moderate/long)
- Graceful degradation: system works perfectly without voice profile (AC-5)
- <50ms context loading (target was <150ms)

**Lesson:** Prompt injection ordering matters. Later injections can override earlier ones, so put the most user-specific instructions last.

### 3. Dual Calibration Paths (Stories 5-3 + 5-7)

**Evidence:** Users can calibrate voice via Golden Set upload (3-5 past proposals) OR Quick Calibration (5-question survey). Both paths produce a VoiceProfile that feeds into generation.

**Impact:**
- Golden Set: 200-word minimum, PDF extraction, up to 5 proposals
- Quick Calibration: Tone, Length, Depth, Structure, CTA style — mapping tables convert answers to numeric profiles
- Users uncomfortable sharing past work have an alternative path
- Both stored in same V21 voice_profiles table

**Lesson:** Offering multiple onboarding paths reduces abandonment. The quick calibration takes seconds while golden set takes minutes, but golden set produces more nuanced profiles.

### 4. VoiceCache with Graceful Recovery (Story 5-8)

**Evidence:** In-memory cache for voice profile with `get/set/invalidate` API. Recovers from mutex poisoning instead of panicking.

**Impact:**
- Poison recovery logs warning and returns None (graceful degradation)
- Cache invalidation integrated into `calibrate_voice` and `quick_calibrate` commands
- `cached_at` timestamp with `age_seconds()` helper for future TTL support
- Eliminates redundant DB queries during proposal generation

**Lesson:** Caches should always degrade gracefully. A panicking cache is worse than no cache.

### 5. Accessibility Improvements Across All Stories

**Evidence:** Every story included keyboard navigation, ARIA attributes, and screen reader considerations:
- 5-2: Arrow key navigation in hook strategy grid
- 5-5: `role="list"`, `role="listitem"`, `aria-label` for voice profile display
- 5-6: `useId()` for unique DOM IDs, click-outside-to-close
- 5-7: Focus trap for calibration questionnaire, radio group keyboard nav
- 5-8: `aria-live` announcements for completion

**Lesson:** Accessibility patterns from Epic 4a/4b are now internalized. The team builds accessible components by default.

### 6. Code Review Catching Integration Gaps (Story 5-3)

**Evidence:** Story 5-3's code review found 3 CRITICAL issues: GoldenSetUpload component wasn't integrated into VoiceCalibrationStep, export was missing from feature index, and AC-1 path was unreachable.

**Impact:**
- Without review, the entire golden set upload would have been dead code
- All 3 CRITICALs fixed immediately
- Demonstrates that even "simple" integration work needs adversarial review

**Lesson:** Component code is not done until it's wired into the UI tree and reachable by users. Integration verification should be a code review checklist item.

---

## What Didn't Go Well (Challenges)

### 1. Story 2-7b Now 5 Epics Deferred

**Evidence:** Story 2-7b (Encrypted Database Access Frontend) has been `backlog` since Epic 2. The Epic 3 retro committed to addressing it. The Epic 4a retro flagged it. The Epic 4b retro called it "decision debt." It's still not done.

**Impact:**
- Frontend passphrase unlock flow not implemented
- Users can't unlock encrypted database on app restart
- The `Mutex<Option<Database>>` state refactor gets harder with every epic (more code depends on current architecture)
- 5 consecutive epics of deferral undermines retro credibility

**Root Cause:** No forcing function. Feature work always takes priority. The "2-epic rule" from the 4b retro was itself not followed.

**Action Required:** This must be escalated beyond a retro action item. It should be treated as a release blocker.

### 2. Test Count Inaccuracies in Story Files

**Evidence:** Stories 5-2, 5-4, and 5-5b all had incorrect test counts in their documentation — code review had to correct claimed vs actual numbers.

**Impact:**
- Creates false confidence in coverage
- Review time spent verifying counts instead of reviewing logic
- Pattern: developers update the count when writing tests but not after adding/removing tests during review fixes

**Root Cause:** Manual test counting is error-prone. No automated count verification.

**Action Required:** Run `vitest --reporter=verbose | wc -l` or equivalent after each story to get accurate counts.

### 3. Critical Integration Gaps (Story 5-3)

**Evidence:** GoldenSetUpload was fully implemented but not wired into VoiceCalibrationStep — 3 CRITICAL issues from a single story. The component was dead code until review caught it.

**Impact:**
- If code review had missed this, the golden set feature would have shipped as unreachable UI
- AC-1 was technically "not implemented" even though the code existed

**Root Cause:** Developing components in isolation without verifying the integration point.

**Action Required:** Add "Integration Verified" as an explicit checklist item in the dev story workflow — verify the component is reachable from the main app flow before marking the story complete.

### 4. voice.rs Growing Unwieldy (600+ Lines)

**Evidence:** Story 5-5b's code review flagged that voice.rs had grown to 600+ lines across 5 stories (5-1, 5-3, 5-4, 5-5b, 5-8). Modularization was deferred.

**Impact:**
- Harder to navigate and maintain
- Higher merge conflict risk if multiple stories touch it
- Testing individual modules becomes harder

**Root Cause:** Incremental growth — each story added functions to the same file. No refactoring checkpoint.

**Action Required:** Split voice.rs into submodules (analysis.rs, profile.rs, cache.rs) — but LOW priority as it works correctly.

### 5. Duplicate Mapping Logic (Story 5-7)

**Evidence:** Quick calibration has mapping tables in BOTH frontend (mapAnswersToProfile.ts) and backend (quick_calibrate command). Both work correctly but are independent implementations.

**Impact:**
- Divergence risk if mapping values change in only one place
- Maintenance burden doubled
- Backend implementation may be dead code if frontend does the mapping

**Root Cause:** Frontend needed immediate mapping for preview; backend was implemented for API completeness.

**Action Required:** Decide single source of truth — likely frontend with backend validation only. LOW priority for MVP.

---

## Key Insights & Lessons Learned

### 1. Local Analysis Is Viable for MVP Quality

**Insight:** Seven text analysis algorithms (sentence segmentation, readability, tone, structure, depth, phrases) running entirely on-device produce usable voice profiles without any external API.

**Evidence:** Story 5-4's analysis completes in <2s for 5 proposals. Users get voice-informed generation without any privacy concerns.

**Application:** Consider local-first analysis for future features before reaching for API calls. The privacy benefit is a competitive advantage.

### 2. Prompt Injection Ordering Is Critical

**Insight:** The order of prompt injections (Base → Humanization → Voice) determines which instructions take precedence. Later injections override earlier ones for conflicting parameters.

**Evidence:** Story 5-8 established the canonical ordering. Voice calibration comes last because it's the most user-specific.

**Application:** Document the prompt injection ordering in the architecture. Any new injection point must specify its position in the chain.

### 3. Multiple Onboarding Paths Reduce Abandonment

**Insight:** Offering both Golden Set upload (detailed, takes minutes) and Quick Calibration (survey, takes seconds) lets users choose their comfort level.

**Evidence:** Stories 5-3 and 5-7 provide parallel paths to the same VoiceProfile output.

**Application:** For any feature requiring user input, consider offering a "quick" alternative alongside the "thorough" path.

### 4. Integration Verification Must Be Explicit

**Insight:** Building a component is not the same as integrating it. Story 5-3's CRITICAL issues prove that isolated component development can produce dead code.

**Evidence:** 3 CRITICALs caught in review — component not imported, not exported, path unreachable.

**Application:** Add "Integration Verified" checklist item to every story. Verify the feature is reachable from the main app navigation before marking complete.

### 5. Graceful Degradation Builds Trust

**Insight:** Every voice feature works without a voice profile (AC-5 pattern). The system generates proposals perfectly fine without calibration — calibration just makes them better.

**Evidence:** Stories 5-8, 5-5, 5-7 all implement graceful fallback to defaults when no voice profile exists.

**Application:** New features should always have a working default state. Never block core functionality on optional configuration.

---

## Technical Debt Identified

### CRITICAL Priority (MVP Blocker, Carried)

1. **Story 2-7b: Encrypted Database Access Frontend** (carried from Epic 2 — **5 epics old**)
   - **Issue:** Frontend passphrase unlock flow not implemented
   - **Impact:** Users can't unlock encrypted database on app restart
   - **Resolution:** RELEASE BLOCKER — schedule immediately, no more deferral

### HIGH Priority (Carried)

2. **API Mocking Infrastructure** (carried from Epic 4a — 3 epics old)
   - **Issue:** No HTTP mocking for Rust tests
   - **Impact:** Claude API call paths untested in automated tests
   - **Resolution:** Less urgent for Epic 5 (local analysis), but still needed for scoring/generation tests

3. **Story 0-5: Validate AI Detection Passing** (Epic 0 — in-progress)
   - **Issue:** AI detection validation incomplete
   - **Impact:** Core product promise unverified

### MEDIUM Priority

4. **voice.rs Modularization** (new from Epic 5)
   - **Issue:** 600+ lines across 5 stories in single file
   - **Impact:** Maintenance burden, merge conflict risk
   - **Resolution:** Split into analysis.rs, profile.rs, cache.rs

5. **Duplicate Quick Calibration Mapping** (new from 5-7)
   - **Issue:** Mapping logic in both frontend and backend
   - **Impact:** Divergence risk
   - **Resolution:** Designate single source of truth

6. **SettingsPanel Test Harness** (carried from Epic 4b)
   - **Issue:** No shared mock factory
   - **Impact:** Mock failures when new settings tabs added
   - **Resolution:** Create shared test helper

### LOW Priority

7. **Syllable counting heuristic** (from 5-4) — simplified, acceptable for MVP
8. **Bullet pattern detection limited to 1-5** (from 5-4) — expand later
9. **Technical terms list incomplete** (from 5-4) — expand for broader domains
10. **WCAG contrast ratio automated testing** (from 5-6) — visual inspection sufficient
11. **Screen reader manual testing** (from 5-2) — requires NVDA/VoiceOver
12. **Windows Rust build environment** (carried from Epic 4a) — still unresolved

**Total New Debt from Epic 5:** 6 items
**Carried from Previous Epics:** 6 items
**Grand Total Outstanding:** 12 items (down from 15 in Epic 4b — some resolved by Epic 8 work)

---

## Previous Epic 4b Retro Follow-Through

| # | Commitment | Status | Evidence |
|---|-----------|--------|----------|
| 1 | Shared SettingsPanel test harness | ❌ Not Addressed | 5-2 still uses individual mocks |
| 2 | Round-trip persistence tests | ✅ Completed | 5-5b: 21 tests (11 unit + 10 integration) with save/load verification |
| 3 | First story = infrastructure debt | ❌ Not Addressed | 5-1 was feature work (hook seed data) |
| 4 | Force Story 2-7b decision | ❌ Not Addressed | Still `backlog` — now 5th epic deferred |
| 5 | API mocking infrastructure | ⏳ N/A | Epic 5 has no API calls to mock (local-only analysis) |
| 6 | SettingsPanel test decomposition | ❌ Not Addressed | No refactor evidence |

**Follow-Through Rate:** 1/6 completed (17%)

**Team Agreements Follow-Through:**

| Agreement | Status | Evidence |
|-----------|--------|----------|
| Round-trip persistence tests | ✅ Applied | 5-5b has comprehensive save/load tests |
| Component thresholds for scoring | ✅ N/A | No scoring work in Epic 5 |
| Feature-sliced folder structure | ✅ Applied | Voice features in features/ directory |
| 2-epic rule for decisions | ❌ Violated | Story 2-7b now at 5 epics |
| Convert action items to patterns | ⏳ Partial | Round-trip test is a pattern; others still chores |

**Key Observation:** The same pattern persists across 3 retros now — architectural patterns (80%+) get followed, explicit chore-style action items (~17%) don't. The 2-7b situation has gone from "decision debt" to "credibility debt" — the team keeps committing to address it and keeps not doing so.

---

## Action Items

### Process Improvements

1. **Add "Integration Verified" checklist item to dev story workflow**
   Owner: SM Agent (Bob)
   Deadline: Next story creation
   Success criteria: Every story checklist includes "Feature reachable from main app flow" verification

2. **Automated test count verification after each story**
   Owner: Dev Agent
   Deadline: Ongoing
   Success criteria: Run `vitest --reporter=verbose` count + `cargo test` count; update story file with actual numbers

3. **Escalate Story 2-7b to RELEASE BLOCKER**
   Owner: Zian (Project Lead)
   Decision: No longer optional — must complete before MVP ship
   Success criteria: 2-7b moved to `ready-for-dev` and implemented

### Technical Debt

4. **Split voice.rs into submodules**
   Owner: Dev Agent
   Priority: MEDIUM
   Target: Next touch of voice module

5. **Resolve duplicate mapping logic (quick calibration)**
   Owner: Dev Agent
   Priority: LOW
   Target: Post-MVP cleanup

### Team Agreements

- "Integration Verified" is a mandatory checklist item for every story
- Features must work without optional configuration (graceful degradation by default)
- Prompt injection ordering is canonical: Base → Humanization → Voice (documented in architecture)
- Local-first analysis preferred when privacy-preserving alternative exists
- Test counts must be machine-verified, not manually claimed
- Story 2-7b: RELEASE BLOCKER — no further deferral permitted

---

## Readiness Assessment

| Dimension | Status | Notes |
|-----------|--------|-------|
| Testing & Quality | ✅ Ready | ~391 tests, all passing, 0 production incidents |
| Deployment | ⏳ Pre-release | Desktop app not yet deployed — MVP not complete |
| Stakeholder Acceptance | ✅ N/A | Solo project |
| Technical Health | ✅ Healthy | Clean voice pipeline, privacy-compliant architecture |
| Unresolved Blockers | ✅ None | All ~62 code review issues resolved |

**Overall:** Epic 5 is fully complete. Voice calibration pipeline is production-ready with privacy compliance.

---

## Retrospective Commitments Summary

- **Stories Completed:** 9/9 (100%) — 6th consecutive 100% epic
- **Technical Debt:** 6 new items + 6 carried = 12 total outstanding
- **Test Coverage:** ~391 tests, HIGH confidence
- **Previous Retro Follow-Through:** 1/6 tasks (17%) — pattern continues unchanged
- **Key Decision Made:** Story 2-7b escalated to RELEASE BLOCKER

### Next Steps

1. **Story 2-7b:** RELEASE BLOCKER — schedule immediately
2. **Story 0-5:** Complete AI Detection Validation
3. **Run remaining retrospectives:** Epics 6 and 8
4. **Mark Epic 5 as done** in sprint-status.yaml
5. **Evaluate post-MVP scope** after MVP items complete

---

## Team Acknowledgments

Epic 5 achieved its primary goal: **complete voice calibration and hook strategy system with privacy-first local analysis, dual calibration paths, and voice-informed proposal generation.**

**Positive Outcomes:**
- FR-5 and FR-16 fully delivered
- 7 local text analysis algorithms (zero API calls)
- AR-12 privacy compliance: only style parameters sent to AI
- Dual calibration: Golden Set + Quick Calibration
- Graceful degradation throughout
- ~391 tests providing high confidence
- 100% story completion for 6th consecutive epic

**Architecture Wins:**
- Ordered prompt injection (Base → Humanization → Voice)
- VoiceCache with poison recovery
- Privacy-first design validated
- Dual onboarding paths reduce user friction
- Accessibility patterns now internalized by team

---

**Retrospective Completed:** 2026-02-11
**Next Retrospective:** Epic 6 (Proposal Editor & Revision History)
**Document:** epic-5-retro-2026-02-11.md
