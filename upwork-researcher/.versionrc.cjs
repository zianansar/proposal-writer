// upwork-researcher/.versionrc.cjs
// Configuration for commit-and-tag-version (semantic versioning automation)
//
// INTEGRATION WITH STORY 9-2 (CI/CD Release Build Pipeline):
// ===========================================================
// This version bump workflow integrates with .github/workflows/release.yml as follows:
//
// 1. Tag Format (AC-4): This config uses tagPrefix: "v", creating tags like v0.1.1, v0.2.0, etc.
//    The release.yml workflow should trigger on:
//      on:
//        push:
//          tags:
//            - 'v*'
//
// 2. Release Notes (AC-5): The CHANGELOG.md generated by this script should be extracted
//    and injected into the GitHub Release body. Recommended approach in release.yml:
//
//      - name: Extract changelog for release
//        id: changelog
//        run: |
//          # Extract content between first two version headers
//          CHANGELOG=$(sed -n '/^## \[/,/^## \[/{/^## \[.*\].*$/!p;}' CHANGELOG.md | head -50)
//          echo "body<<EOF" >> $GITHUB_OUTPUT
//          echo "$CHANGELOG" >> $GITHUB_OUTPUT
//          echo "EOF" >> $GITHUB_OUTPUT
//        working-directory: upwork-researcher
//
//      - uses: tauri-apps/tauri-action@v0
//        with:
//          releaseBody: ${{ steps.changelog.outputs.body }}
//          releaseDraft: true
//
// 3. Workflow: To create a new release:
//    a. Run: npm run version:bump (or version:bump:minor/major)
//    b. This script bumps version in 3 files, updates CHANGELOG, commits, and creates tag
//    c. Push tag: git push --follow-tags origin main
//    d. GitHub Actions (Story 9-2) detects v* tag and triggers Tauri build + release
//
// Custom TOML updater for Cargo.toml version field under [package]
const tomlUpdater = {
  readVersion(contents) {
    const match = contents.match(
      /^\[package\]\s*\n(?:.*\n)*?version\s*=\s*"([^"]+)"/m
    );
    return match ? match[1] : undefined;
  },
  writeVersion(contents, version) {
    return contents.replace(
      /(^\[package\]\s*\n(?:.*\n)*?version\s*=\s*")([^"]+)(")/m,
      `$1${version}$3`
    );
  },
};

module.exports = {
  packageFiles: [{ filename: "package.json", type: "json" }],
  bumpFiles: [
    { filename: "package.json", type: "json" },
    { filename: "src-tauri/Cargo.toml", updater: tomlUpdater },
    { filename: "src-tauri/tauri.conf.json", type: "json" },
  ],
  releaseCommitMessageFormat: "chore: release v{{currentTag}}",
  tagPrefix: "v",
  types: [
    { type: "feat", section: "Features" },
    { type: "fix", section: "Bug Fixes" },
    { type: "perf", section: "Performance" },
    { type: "refactor", section: "Refactoring" },
    { type: "docs", section: "Documentation", hidden: true },
    { type: "style", section: "Styles", hidden: true },
    { type: "chore", section: "Maintenance", hidden: true },
    { type: "test", section: "Tests", hidden: true },
    { type: "ci", section: "CI/CD", hidden: true },
    { type: "build", section: "Build", hidden: true },
  ],
};
